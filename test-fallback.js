// Test script to verify fallback metadata creation

// Mock the createHardcodedMetadata function
function createHardcodedMetadata(greetingData, selectedDesign, recipient) {
  const generateGreetingTitle = (greetingData) => {
    if (greetingData?.title) return greetingData.title;
    if (greetingData?.festival) return `${greetingData.festival} Greeting`;
    return `Festival Greeting ${new Date().getFullYear()}`;
  };

  const extractFestivalType = (greetingData) => {
    if (greetingData?.festival) return greetingData.festival;
    if (greetingData?.occasion) return greetingData.occasion;
    return "Festival";
  };

  const metadata = {
    name: generateGreetingTitle(greetingData),
    description: greetingData?.message || greetingData?.greeting || "AI-generated festival greeting",
    image: "https://via.placeholder.com/400x600/FFD700/000000?text=Festify+Greeting",
    external_url: "https://festify.ai",
    attributes: [
      {
        trait_type: "Festival Type",
        value: extractFestivalType(greetingData)
      },
      {
        trait_type: "Design Theme",
        value: selectedDesign
      },
      {
        trait_type: "Generated By",
        value: "Festify AI"
      },
      {
        trait_type: "Created At",
        value: new Date().toISOString()
      },
      {
        trait_type: "Recipient",
        value: recipient
      },
      {
        trait_type: "Metadata Source",
        value: "Fallback (Pinata Unavailable)"
      }
    ]
  };
  
  // Return as data URI to avoid IPFS dependency
  const jsonString = JSON.stringify(metadata, null, 2);
  const base64String = Buffer.from(jsonString).toString('base64');
  
  return `data:application/json;base64,${base64String}`;
}

// Test the function
function testFallbackMetadata() {
  console.log('ğŸ§ª Testing Fallback Metadata Creation...\n');
  
  const testGreetingData = {
    festival: "Diwali",
    message: "Happy Diwali! May the festival of lights bring joy and prosperity to your life.",
    title: "Diwali Greeting 2024"
  };
  
  const testRecipient = "0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6";
  const testDesign = "festive-gold";
  
  try {
    const metadataURI = createHardcodedMetadata(testGreetingData, testDesign, testRecipient);
    
    console.log('âœ… Metadata URI created successfully!');
    console.log('ğŸ“ URI length:', metadataURI.length);
    console.log('ğŸ”— URI starts with:', metadataURI.substring(0, 50) + '...');
    
    // Decode and verify the metadata
    const base64Data = metadataURI.replace('data:application/json;base64,', '');
    const decodedJson = Buffer.from(base64Data, 'base64').toString('utf8');
    const metadata = JSON.parse(decodedJson);
    
    console.log('\nğŸ“‹ Decoded Metadata:');
    console.log('Name:', metadata.name);
    console.log('Description:', metadata.description);
    console.log('Image:', metadata.image);
    console.log('Attributes count:', metadata.attributes.length);
    
    console.log('\nğŸ·ï¸ Attributes:');
    metadata.attributes.forEach((attr, index) => {
      console.log(`${index + 1}. ${attr.trait_type}: ${attr.value}`);
    });
    
    // Verify required fields
    const requiredFields = ['name', 'description', 'image', 'attributes'];
    const missingFields = requiredFields.filter(field => !metadata[field]);
    
    if (missingFields.length === 0) {
      console.log('\nâœ… All required fields present!');
      console.log('âœ… Fallback metadata creation test PASSED!');
    } else {
      console.log('\nâŒ Missing required fields:', missingFields);
      console.log('âŒ Fallback metadata creation test FAILED!');
    }
    
  } catch (error) {
    console.error('âŒ Error testing fallback metadata:', error.message);
    console.log('âŒ Fallback metadata creation test FAILED!');
  }
}

// Run the test
testFallbackMetadata(); 